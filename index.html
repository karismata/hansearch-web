<!DOCTYPE html>
<html lang="ko">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta charset="UTF-8" />
  <title>HanSearch ëª¨ë°”ì¼</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    @supports (-webkit-touch-callout: none) {
      body {
        max-width: 100vw;
        overflow-x: hidden;
      }
    }

    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f2f4f8;
    }

    /* ëª¨ë‹¬ ì—´ë ¸ì„ ë•Œ ì „ì²´ ìŠ¤í¬ë¡¤ ì°¨ë‹¨ */
    body.no-scroll {
      overflow: hidden;
    }

    .app {
      max-width: 480px;
      margin: auto;
      min-height: 100vh;
    }

    /* PC ëª¨ë“œ */
    body.pc-mode {
      background: #e9ecf3;
    }
    body.pc-mode .app {
      max-width: 1200px;
    }
    body.pc-mode .result-item {
      font-size: 16px;
    }
    body.pc-mode .images img {
      height: 160px;
    }
    body.pc-mode .img-modal {
      width: 90%;
      max-width: 1200px;
      height: 90vh;
    }

    .header-title {
      position: relative;
      text-align: center;
      left: 0;
      transform: none;
    }

    #result {
      min-height: 50vh;
    }

    /* ============= ì´ë¯¸ì§€ ëª¨ë‹¬ ============= */

    .img-modal {
      position: fixed;
      z-index: 2000;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 94%;
      max-width: 430px;
      height: 75vh;
      background: rgba(0,0,0,0.9);
      border-radius: 14px;
      padding: 10px;
      box-sizing: border-box;
      overflow: hidden;
    }

    .img-modal.hidden {
      display: none;
    }

    .img-viewer {
      position: relative;  /* ìŠ¬ë¼ì´ë” ë²„íŠ¼ ìœ„ì¹˜ ê¸°ì¤€ */
      width: 100%;
      height: 100%;
      overflow: hidden;
      touch-action: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: grab;
    }

    #imgModalContent {
      transform-origin: center center;
      transition: transform 0.05s linear;

      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;   /* ë¹„ìœ¨ ìœ ì§€ */

      user-drag: none;
      -webkit-user-drag: none;

      pointer-events: none;  /* ë“œë˜ê·¸ ì¶©ëŒ ë°©ì§€ */
      border-radius: 12px;
      background: white;
    }

    .img-close {
      position: absolute;
      top: 16px;
      right: 20px;
      font-size: 30px;
      color: white;
      cursor: pointer;
      z-index: 3000;
    }

    /* ìŠ¬ë¼ì´ë” ë²„íŠ¼ */
    .img-prev,
    .img-next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 3000;
    }

    .img-prev {
      left: 10px;
    }

    .img-next {
      right: 10px;
    }

    /* ============= ê¸°ë³¸ UI ============= */

    .search-row {
      display: flex;
      gap: 8px;
    }

    .category-small {
      width: 30%;
      min-width: 90px;
    }

    .keyword-wide {
      width: 70%;
    }

    .category {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .header {
      background: #1f3c88;
      color: white;
      padding: 18px 16px;
      font-size: 18px;
      font-weight: bold;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      min-height: 64px;
    }

    .user-icon {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 22px;
      cursor: pointer;
      color: white;
      background: none;
    }

    .user-menu {
      position: absolute;
      top: 60px;
      right: 16px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,.15);
      overflow: hidden;
      width: 180px;
      display: none;
      z-index: 1000;
    }

    .user-menu div {
      padding: 14px;
      font-size: 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      color: #000;
    }

    .user-menu div:last-child {
      border-bottom: none;
    }

    .user-menu div:hover {
      background: #f2f4f8;
    }

    .box {
      background: white;
      margin: 0;
      padding: 20px;
      box-shadow: none;
    }

    .search-card {
      margin: 0;
      border-radius: 0;
      box-shadow: none;
    }

    input, select {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 12px;
      border: 1px solid #ddd;
      box-sizing: border-box;
      margin-top: 10px;
    }

    button {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      margin-top: 12px;
    }

    .btn-primary {
      background: #1f3c88;
      color: white;
    }

    .hidden {
      display: none;
    }

    .result-item {
      background: #f9fafc;
      border-radius: 12px;
      padding: 14px;
      margin-top: 14px;
      font-size: 15px;
      line-height: 1.6;
      box-shadow: 0 2px 6px rgba(0,0,0,.05);
      word-break: break-word;
      white-space: normal;
    }

    .category {
      font-size: 12px;
      color: #888;
      margin-bottom: 2px;
    }

    .images {
      margin-top: 10px;
      display: flex;
      gap: 6px;
      overflow-x: auto;
    }

    .images img {
      height: 120px;
      border-radius: 10px;
      cursor: pointer;
    }

    .login-title {
      text-align: center;
      font-weight: bold;
      font-size: 20px;
      margin-bottom: 16px;
    }

    .sub {
      font-size: 13px;
      color: #666;
      text-align: center;
      margin-top: 10px;
    }

    .pager {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      margin: 20px 0;
      flex-wrap: nowrap;
    }

    .pager button {
      padding: 8px 12px;
      font-size: 13px;
      background: #eee;
      color: #333;
      border-radius: 8px;
      border: none;
      min-width: 36px;
    }

    .pager button.active {
      background: #1f3c88;
      color: white;
    }

    .pager button.arrow {
      font-weight: bold;
    }

    input[type="checkbox"] {
      display: none !important;
    }

    .bottom-control-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 6px 0 12px;
    }

    .page-size-select,
    .pc-toggle-btn {
      width: 90px;
      height: 34px;
      font-size: 12px;
      line-height: 34px;
      border-radius: 10px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 10px;
    }

    .page-size-select {
      background: #fff;
      color: #000;
    }

    .pc-toggle-btn {
      background: #1f3c88;
      color: #fff;
      cursor: pointer;
      white-space: nowrap;
    }
  </style>
</head>

<body>
<div class="app">

  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-title">HanSearch Web</div>
    <div class="user-icon hidden" id="userIcon" onclick="toggleUserMenu()">ğŸ‘¤</div>

    <div class="user-menu" id="userMenu">
      <div onclick="changePassword()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
      <div onclick="logout()">ë¡œê·¸ì•„ì›ƒ</div>
    </div>
  </div>

  <!-- ë¡œê·¸ì¸ ë°•ìŠ¤ -->
  <div class="box" id="loginBox">
    <div class="login-title">ì§ì› ë¡œê·¸ì¸</div>
    <input id="email" placeholder="ì´ë©”ì¼">
    <input id="password" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
    <button class="btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
    <p id="msg" class="sub"></p>
  </div>

  <!-- ê²€ìƒ‰ ë°•ìŠ¤ -->
  <div class="box search-card hidden" id="searchBox">

    <div class="search-row">
      <select id="categorySelect" class="category-small">
        <option value="">ì „ì²´</option>
      </select>

      <input
        id="keyword"
        class="keyword-wide"
        placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”"
      >
    </div>

    <button class="btn-primary" onclick="search()">ê²€ìƒ‰</button>
    <div id="result"></div>
    <div class="pager" id="pager"></div>

    <!-- í•˜ë‹¨ ì»¨íŠ¸ë¡¤ -->
    <div class="bottom-control-wrap">
      <select id="pageSize" class="page-size-select">
        <option value="5">5ê°œ</option>
        <option value="8" selected>8ê°œ</option>
        <option value="15">15ê°œ</option>
        <option value="30">30ê°œ</option>
      </select>

      <button class="pc-toggle-btn" onclick="togglePCMode()">
        PC ëª¨ë“œ
      </button>
    </div>

  </div>

<script>
  const SUPABASE_URL = "https://trtpgahsnuddenmxuazq.supabase.co";
  const SUPABASE_KEY = "sb_publishable_N_NBrRMNfUDwfCodR-nZ6g_KCFEZiw1";

  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );

  let allData = [];
  let currentPage = 1;
  let selectedCategory = "";
  let categoryList = [];

  // ë¡œê·¸ì¸
  async function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    document.getElementById("msg").innerText = "ë¡œê·¸ì¸ ì¤‘...";

    const { error } = await supabaseClient.auth.signInWithPassword({
      email, password
    });

    if (error) {
      document.getElementById("msg").innerText = "âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨";
    } else {
      document.getElementById("msg").innerText = "";
      showSearch();
    }
  }

  function toggleUserMenu() {
    const menu = document.getElementById("userMenu");
    menu.style.display = menu.style.display === "block" ? "none" : "block";
  }

  async function changePassword() {
    const currentPw = prompt("í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    if (!currentPw) return;

    const newPw = prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
    if (!newPw) return;

    const { data: sessionData } = await supabaseClient.auth.getSession();
    const email = sessionData.session.user.email;

    const { error: reauthError } = await supabaseClient.auth.signInWithPassword({
      email,
      password: currentPw
    });

    if (reauthError) {
      alert("âŒ í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
      return;
    }

    const { error: updateError } = await supabaseClient.auth.updateUser({
      password: newPw
    });

    if (updateError) {
      alert("âŒ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨");
    } else {
      alert("âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
      toggleUserMenu();
    }
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    location.reload();
  }

  // ë¡œê·¸ì¸ í›„ í™”ë©´ ì „í™˜
  function showSearch() {
    const loginBox = document.getElementById("loginBox");
    const searchBox = document.getElementById("searchBox");
    const userIcon = document.getElementById("userIcon");

    loginBox.style.display = "none";
    searchBox.classList.remove("hidden");
    searchBox.style.display = "block";
    userIcon.classList.remove("hidden");

    loadCategories();
  }

  // ì´ë¯¸ ë¡œê·¸ì¸ ìƒíƒœì¸ì§€ ì²´í¬
  async function checkLogin() {
    const { data } = await supabaseClient.auth.getSession();
    if (data.session) {
      showSearch();
    }
  }

  // ì¹´í…Œê³ ë¦¬ ë¡œë“œ
  async function loadCategories() {
    const { data, error } = await supabaseClient
      .from("info")
      .select("í‚¤ì›Œë“œ");

    if (error) {
      console.log("ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨", error);
      return;
    }

    const select = document.getElementById("categorySelect");
    select.innerHTML = `<option value="">ì „ì²´</option>`;

    const categories = [...new Set(data.map(d => d.í‚¤ì›Œë“œ).filter(Boolean))];

    categories.forEach(cat => {
      const option = document.createElement("option");
      option.value = cat;
      option.innerText = cat;
      select.appendChild(option);
    });
  }

  function selectCategory(cat, btn) {
    selectedCategory = cat;

    document.querySelectorAll(".category-btn").forEach(b => {
      b.classList.remove("active");
    });

    btn.classList.add("active");
  }

  // ê²€ìƒ‰ (í‚¤ì›Œë“œ2 AND ê²€ìƒ‰)
  async function search() {
    const keyword = document.getElementById("keyword").value.trim();
    const category = document.getElementById("categorySelect").value;

    const { data, error } = await supabaseClient
      .from("info")
      .select("*")
      .ilike("í‚¤ì›Œë“œ", `%${category}%`);

    if (error) {
      alert("âŒ ê²€ìƒ‰ ì˜¤ë¥˜");
      return;
    }

    const keywords = keyword
      .toLowerCase()
      .split(/\s+/)
      .filter(k => k.length > 0);

    const filtered = data.filter(row => {
      const target = (row.í‚¤ì›Œë“œ2 || "").toLowerCase();
      return keywords.every(word => target.includes(word));
    });

    filtered.sort((a, b) => {
      return (b.ì¤‘ìš” === true) - (a.ì¤‘ìš” === true);
    });

    allData = filtered;
    currentPage = 1;
    renderPage();
  }

  function renderPage() {
    const pageSize = Number(document.getElementById("pageSize").value);
    const start = (currentPage - 1) * pageSize;
    const end = start + pageSize;
    const pageData = allData.slice(start, end);

    const resultBox = document.getElementById("result");
    resultBox.innerHTML = "";

    if (pageData.length === 0) {
      resultBox.innerHTML =
        '<div style="text-align:center; color:#999; padding:40px 0;">ê²€ìƒ‰ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      document.getElementById("pager").innerHTML = "";
      return;
    }

    pageData.forEach(row => {
      const div = document.createElement("div");
      div.className = "result-item";

      const cat = document.createElement("div");
      cat.className = "category";

      if (row.ì¤‘ìš” === true) cat.innerHTML = 'â­ ' + (row.í‚¤ì›Œë“œ || "");
      else cat.innerText = row.í‚¤ì›Œë“œ || "";

      const kw2 = document.createElement("div");
      kw2.style.fontSize = "16px";
      kw2.style.fontWeight = "bold";
      kw2.style.color = "#1f3c88";
      kw2.style.marginBottom = "6px";
      kw2.innerText = row.í‚¤ì›Œë“œ2 || "";

      const text = document.createElement("div");
      let content = (row.ë‚´ìš© || "")
        .replace(/\\n/g, "<br>")
        .replace(/\n/g, "<br>")
        .replace(
          /(https?:\/\/[^\s<]+)/g,
          '<a href="$1" target="_blank" style="color:#1f3c88; text-decoration:underline;">$1</a>'
        );
      text.innerHTML = content;

      const imgBox = document.createElement("div");
      imgBox.className = "images";

      if (row.ì´ë¯¸ì§€ë“¤) {
        const imgUrls = row.ì´ë¯¸ì§€ë“¤
          .split(";")
          .map(u => u.trim())
          .filter(u => u);

        imgUrls.forEach((url, i) => {
          const img = document.createElement("img");
          img.src = url;
          img.onclick = () => openImageModal(imgUrls, i);   // ìŠ¬ë¼ì´ë”ìš©
          imgBox.appendChild(img);
        });
      }

      div.appendChild(cat);
      div.appendChild(kw2);
      div.appendChild(text);
      div.appendChild(imgBox);

      resultBox.appendChild(div);
    });

    renderPager();
  }

  function renderPager() {
    const pageSize = Number(document.getElementById("pageSize").value);
    const totalPage = Math.ceil(allData.length / pageSize);
    const pager = document.getElementById("pager");
    pager.innerHTML = "";

    if (totalPage <= 1) return;

    const maxVisible = 7;
    let start = Math.max(1, currentPage - Math.floor(maxVisible / 2));
    let end = start + maxVisible - 1;

    if (end > totalPage) {
      end = totalPage;
      start = Math.max(1, end - maxVisible + 1);
    }

    const prevBtn = document.createElement("button");
    prevBtn.innerText = "â—€";
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
      currentPage--;
      renderPage();
    };
    pager.appendChild(prevBtn);

    for (let i = start; i <= end; i++) {
      const btn = document.createElement("button");
      btn.innerText = i;
      if (i === currentPage) btn.classList.add("active");
      btn.onclick = () => {
        currentPage = i;
        renderPage();
      };
      pager.appendChild(btn);
    }

    const nextBtn = document.createElement("button");
    nextBtn.innerText = "â–¶";
    nextBtn.disabled = currentPage === totalPage;
    nextBtn.onclick = () => {
      currentPage++;
      renderPage();
    };
    pager.appendChild(nextBtn);
  }

  document.getElementById("pageSize").addEventListener("change", () => {
    currentPage = 1;
    renderPage();
  });

  window.addEventListener("click", (e) => {
    const menu = document.getElementById("userMenu");
    const icon = document.getElementById("userIcon");
    if (!icon.contains(e.target) && !menu.contains(e.target)) {
      menu.style.display = "none";
    }
  });

  document.getElementById("keyword").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      search();
    }
  });

  document.getElementById("categorySelect").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
      search();
    }
  });

  function togglePCMode() {
    document.body.classList.toggle("pc-mode");
    const btn = document.querySelector(".pc-toggle-btn");
    if (!btn) return;
    btn.innerText = document.body.classList.contains("pc-mode") ? "ëª¨ë°”ì¼ ëª¨ë“œ" : "PC ëª¨ë“œ";
  }

  /* ========= ì´ë¯¸ì§€ í™•ëŒ€ / ë“œë˜ê·¸ / íœ  í™•ëŒ€ + ìŠ¬ë¼ì´ë” ========= */

  let scale = 1;
  let posX = 0, posY = 0;
  let dragStartX = 0, dragStartY = 0;
  let isDragging = false;

  // ìŠ¬ë¼ì´ë” ë°ì´í„°
  let galleryImages = [];
  let currentIndex = 0;

  function applyTransform() {
    const img = document.getElementById("imgModalContent");
    if (!img) return;
    img.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
  }

  function loadModalImage() {
    const img = document.getElementById("imgModalContent");
    if (!img || galleryImages.length === 0) return;
    img.src = galleryImages[currentIndex];
    // ì´ë¯¸ì§€ ë°”ê¿€ ë•Œë§ˆë‹¤ ìœ„ì¹˜/ë°°ìœ¨ ë¦¬ì…‹
    scale = 1;
    posX = 0;
    posY = 0;
    applyTransform();
  }

  // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸° (ì—¬ëŸ¬ ì´ë¯¸ì§€ + ì‹œì‘ ì¸ë±ìŠ¤)
  function openImageModal(images, index) {
    const modal = document.getElementById("imgModal");
    const viewer = document.getElementById("imgViewer");

    if (!modal || !viewer) return;

    galleryImages = images || [];
    currentIndex = index || 0;

    loadModalImage();

    modal.classList.remove("hidden");
    document.body.classList.add("no-scroll");

    // íœ  ì¤Œ
    viewer.onwheel = (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -0.15 : 0.15;
      scale = Math.min(Math.max(scale + delta, 1), 5);
      applyTransform();
    };

    // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸
    viewer.onmousedown = (e) => {
      isDragging = true;
      dragStartX = e.clientX - posX;
      dragStartY = e.clientY - posY;
      viewer.style.cursor = "grabbing";
    };

    document.onmousemove = (e) => {
      if (!isDragging) return;
      posX = e.clientX - dragStartX;
      posY = e.clientY - dragStartY;
      applyTransform();
    };

    document.onmouseup = () => {
      isDragging = false;
      viewer.style.cursor = "grab";
    };
  }

  function closeImageModal() {
    const modal = document.getElementById("imgModal");
    if (!modal) return;
    modal.classList.add("hidden");
    document.body.classList.remove("no-scroll");
  }

  // ì´ì „/ë‹¤ìŒ ì´ë¯¸ì§€
  function prevImage() {
    if (!galleryImages.length) return;
    currentIndex = (currentIndex - 1 + galleryImages.length) % galleryImages.length;
    loadModalImage();
  }

  function nextImage() {
    if (!galleryImages.length) return;
    currentIndex = (currentIndex + 1) % galleryImages.length;
    loadModalImage();
  }

  // ì´ˆê¸° ë¡œê·¸ì¸ ì²´í¬
  checkLogin();

  // ì´ë¯¸ì§€ ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° (ì´ë¯¸ì§€/ë²„íŠ¼ í´ë¦­ì€ ìœ ì§€)
  document.addEventListener("DOMContentLoaded", () => {
    const modal = document.getElementById("imgModal");
    const viewer = document.getElementById("imgViewer");

    if (!modal || !viewer) return;

    // ëª¨ë‹¬ ë‚´ë¶€(viewer) í´ë¦­ì€ ë‹«ê¸° ë§‰ê¸°
    viewer.addEventListener("click", (e) => {
      e.stopPropagation();
    });

    // ë°”ê¹¥(ì–´ë‘ìš´ ì˜ì—­) í´ë¦­ ì‹œ ë‹«ê¸°
    modal.addEventListener("click", () => {
      closeImageModal();
    });
  });
</script>

<!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
<div id="imgModal" class="img-modal hidden">
  <span class="img-close" onclick="closeImageModal()">Ã—</span>

  <div class="img-viewer" id="imgViewer">
    <button type="button" class="img-prev" onclick="prevImage()">â€¹</button>
    <img id="imgModalContent" />
    <button type="button" class="img-next" onclick="nextImage()">â€º</button>
  </div>
</div>

</div>
</body>
</html>
